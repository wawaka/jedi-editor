<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JEDI - JSON Schema Editor</title>

  <script type="importmap">
  {
    "imports": {
      "lit": "./vendor/lit.js",
      "ajv": "./vendor/ajv.js",
      "ajv-formats": "./vendor/ajv-formats.js"
    }
  }
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--page-bg, #0a0e27);
      color: var(--page-text, #ffffff);
      transition: background 0.2s ease, color 0.2s ease;
    }

    body.theme-light {
      --page-bg: #f8fafc;
      --page-text: #1e293b;
      --page-bg-secondary: #ffffff;
      --page-border: #e2e8f0;
      --page-text-muted: #64748b;
      --page-accent: #2563eb;
      --page-success: #059669;
    }

    body.theme-dark {
      --page-bg: #0a0e27;
      --page-text: #ffffff;
      --page-bg-secondary: #0f1629;
      --page-border: #1e2a4a;
      --page-text-muted: #9ca3af;
      --page-accent: #4da6ff;
      --page-success: #00ff88;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 1rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: var(--page-bg-secondary, #0f1629);
      border-radius: 0.5rem 0.5rem 0 0;
      border: 1px solid var(--page-border, #1e2a4a);
      border-bottom: none;
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    header h1 {
      font-size: 1.125rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    header h1 .badge {
      font-size: 0.625rem;
      font-weight: 500;
      padding: 0.125rem 0.5rem;
      background: rgba(77, 166, 255, 0.2);
      color: var(--page-accent, #4da6ff);
      border-radius: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    header p {
      font-size: 0.75rem;
      color: var(--page-text-muted, #9ca3af);
    }

    .controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .controls button {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .controls button.primary {
      background: #1d4ed8;
      color: white;
    }

    .controls button.primary:hover {
      background: #2563eb;
    }

    .controls button.secondary {
      background: var(--page-border, #1e2a4a);
      color: var(--page-text-muted, #9ca3af);
    }

    .controls button.secondary:hover {
      background: var(--page-bg, #2d3a5a);
      color: var(--page-text, white);
    }

    .controls button.danger {
      background: transparent;
      color: #ff4444;
      border: 1px solid rgba(255, 68, 68, 0.3);
    }

    .controls button.danger:hover {
      background: rgba(255, 68, 68, 0.1);
    }

    .controls .divider {
      width: 1px;
      height: 1.25rem;
      background: var(--page-border, #1e2a4a);
    }

    .controls .status {
      font-size: 0.75rem;
      color: var(--page-text-muted, #9ca3af);
      padding: 0 0.5rem;
    }

    .controls .status.saved {
      color: var(--page-success, #00ff88);
    }

    .editor-wrapper {
      flex: 1;
      min-height: 0;
      border: 1px solid var(--page-border, #1e2a4a);
      border-radius: 0 0 0.5rem 0.5rem;
      overflow: hidden;
      transition: border-color 0.2s ease;
    }

    jedi-editor {
      height: 100%;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--page-text-muted, #9ca3af);
      font-size: 0.875rem;
      background: var(--page-bg-secondary, #0f1629);
    }

    .loading::after {
      content: '';
      width: 1.5rem;
      height: 1.5rem;
      margin-left: 0.75rem;
      border: 2px solid var(--page-border, #1e2a4a);
      border-top-color: var(--page-accent, #4da6ff);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Lightweight toast */
    .toast-container {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      pointer-events: none;
    }

    .toast {
      background: var(--page-bg-secondary, #0f1629);
      color: var(--page-text, #fff);
      border: 1px solid var(--page-border, #1e2a4a);
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.8125rem;
      opacity: 0;
      transform: translateY(1rem);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="toast-container"><div class="toast"></div></div>
  <div class="container">
    <header>
      <div>
        <h1>
          JEDI
          <span class="badge">JSON Schema Editor</span>
        </h1>
        <p>Visual JSON editing with schema validation</p>
      </div>
      <div class="controls">
        <span id="status" class="status"></span>
        <div class="divider"></div>
        <jedi-theme-selector id="theme-selector"></jedi-theme-selector>
        <div class="divider"></div>
        <button id="btn-grid" class="secondary" title="Toggle debug grid">Grid</button>
        <button id="btn-reset" class="secondary" title="Reset to example data">Reset</button>
      </div>
    </header>

    <div class="editor-wrapper">
      <div id="loading" class="loading">Loading editor components</div>
      <jedi-editor id="editor" style="display: none;">
        <!-- Custom controls injected into schema pane header -->
        <div slot="schema-header-controls">
          <select id="select-schema-template" title="Load schema template">
            <option value="">Template...</option>
            <option value="user">User Profile</option>
            <option value="product">Product</option>
            <option value="order">Order</option>
            <option value="config">App Config</option>
          </select>
          <span class="divider"></span>
          <button id="btn-copy-schema" title="Copy schema to clipboard">Copy</button>
          <button id="btn-download-schema" title="Download schema as JSON">Export</button>
        </div>
        <!-- Custom controls injected into data pane header -->
        <div slot="data-header-controls">
          <select id="select-data-preset" title="Load sample data">
            <option value="">Sample data...</option>
            <option value="valid">Valid Example</option>
            <option value="minimal">Minimal</option>
            <option value="full">Full Record</option>
            <option value="invalid">Invalid (for testing)</option>
          </select>
          <span class="divider"></span>
          <button id="btn-copy-data" title="Copy data to clipboard">Copy</button>
          <button id="btn-download-data" title="Download data as JSON">Export</button>
        </div>
      </jedi-editor>
    </div>
  </div>

  <script type="module">
    // Import the main editor component
    import './src/index.js';

    // ═══════════════════════════════════════════════════════════════
    // Elaborate Example Schema and Data
    // ═══════════════════════════════════════════════════════════════

    const EXAMPLE_SCHEMA = {
      type: 'object',
      properties: {
        id: { type: 'integer' },
        name: { type: 'string' },
        email: { type: 'string' },
        age: { type: 'integer' },
        isActive: { type: 'boolean' },
        role: {
          type: 'string',
          enum: ['admin', 'user', 'guest']
        },
        address: {
          type: 'object',
          properties: {
            street: { type: 'string' },
            city: { type: 'string' },
            zipCode: { type: 'string' },
            country: { type: 'string' }
          }
        },
        tags: {
          type: 'array',
          items: { type: 'string' }
        },
        settings: {
          type: 'object',
          properties: {
            theme: { type: 'string', enum: ['light', 'dark', 'auto'] },
            notifications: { type: 'boolean' },
            language: { type: 'string' }
          }
        }
      },
      required: ['id', 'name', 'email']
    };

    const EXAMPLE_DATA = {
      id: 1,
      name: 'John Doe',
      email: 'john@example.com',
      age: 32,
      isActive: true,
      role: 'admin',
      address: {
        street: '123 Main St',
        city: 'New York',
        zipCode: '10001',
        country: 'USA'
      },
      tags: ['developer', 'designer', 'manager'],
      settings: {
        theme: 'dark',
        notifications: true,
        language: 'en'
      }
    };

    // Storage keys for demo persistence
    const STORAGE_KEY_SCHEMA = 'json-editor-demo-schema';
    const STORAGE_KEY_DATA = 'json-editor-demo-data';

    // ═══════════════════════════════════════════════════════════════
    // Initialize Editor
    // ═══════════════════════════════════════════════════════════════

    const editor = document.getElementById('editor');
    const statusEl = document.getElementById('status');

    // Check for saved data in localStorage
    function loadFromStorage() {
      try {
        const savedSchema = localStorage.getItem(STORAGE_KEY_SCHEMA);
        const savedData = localStorage.getItem(STORAGE_KEY_DATA);
        if (savedSchema && savedData) {
          return {
            schema: JSON.parse(savedSchema),
            data: JSON.parse(savedData)
          };
        }
      } catch (e) {
        console.error('Failed to load from localStorage:', e);
      }
      return null;
    }

    function saveToStorage(schema, data) {
      try {
        localStorage.setItem(STORAGE_KEY_SCHEMA, JSON.stringify(schema));
        localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(data));
        updateStatus(true);
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    }

    function clearStorage() {
      localStorage.removeItem(STORAGE_KEY_SCHEMA);
      localStorage.removeItem(STORAGE_KEY_DATA);
      updateStatus(false);
    }

    function hasSaved() {
      return localStorage.getItem(STORAGE_KEY_SCHEMA) !== null;
    }

    function updateStatus(saved) {
      if (saved || hasSaved()) {
        statusEl.textContent = 'Auto-saved';
        statusEl.className = 'status saved';
      } else {
        statusEl.textContent = '';
        statusEl.className = 'status';
      }
    }

    // Theme selector element
    const themeSelector = document.getElementById('theme-selector');

    // Theme storage key (must match theme-service.js)
    const THEME_STORAGE_KEY = 'jedi-editor-theme';
    const DEFAULT_THEME = 'dark';

    // Apply theme to page body
    function applyPageTheme(theme) {
      document.body.classList.remove('theme-dark', 'theme-light');
      document.body.classList.add(`theme-${theme}`);
    }

    // Get saved theme from localStorage
    function getSavedTheme() {
      try {
        return localStorage.getItem(THEME_STORAGE_KEY) || DEFAULT_THEME;
      } catch {
        return DEFAULT_THEME;
      }
    }

    // Apply saved theme immediately (before editor loads)
    const initialTheme = getSavedTheme();
    applyPageTheme(initialTheme);
    themeSelector.theme = initialTheme;

    // Wait for component to be defined and ready
    customElements.whenDefined('jedi-editor').then(async () => {
      // Wait for first render cycle to complete
      await editor.updateComplete;

      // Load saved data or use example
      const saved = loadFromStorage();
      if (saved) {
        editor.setState(saved.schema, saved.data);
      } else {
        editor.setState(EXAMPLE_SCHEMA, EXAMPLE_DATA);
      }

      // Show editor
      document.getElementById('loading').style.display = 'none';
      document.getElementById('editor').style.display = '';

      updateStatus(hasSaved());
    });

    // ═══════════════════════════════════════════════════════════════
    // Auto-save on changes
    // ═══════════════════════════════════════════════════════════════

    editor.addEventListener('schema-change', (e) => {
      saveToStorage(e.detail.schema, editor.data);
    });

    editor.addEventListener('data-change', (e) => {
      saveToStorage(editor.schema, e.detail.data);
    });

    editor.addEventListener('validation-change', (e) => {
      console.log('Validation:', e.detail.isValid ? 'Valid' : 'Invalid', e.detail.errors);
    });

    // Theme change from selector
    themeSelector.addEventListener('theme-change', (e) => {
      editor.theme = e.detail.theme;
      applyPageTheme(e.detail.theme);
    });

    // Theme change from editor (if set programmatically)
    editor.addEventListener('theme-change', (e) => {
      themeSelector.theme = e.detail.theme;
      applyPageTheme(e.detail.theme);
    });

    // ═══════════════════════════════════════════════════════════════
    // Button Handlers
    // ═══════════════════════════════════════════════════════════════

    document.getElementById('btn-reset').addEventListener('click', () => {
      if (confirm('Reset to example data?')) {
        editor.setState(EXAMPLE_SCHEMA, EXAMPLE_DATA);
      }
    });

    document.getElementById('btn-grid').addEventListener('click', () => {
      editor.debugGrid = !editor.debugGrid;
      document.getElementById('btn-grid').classList.toggle('primary', editor.debugGrid);
      document.getElementById('btn-grid').classList.toggle('secondary', !editor.debugGrid);
    });

    // ═══════════════════════════════════════════════════════════════
    // Custom Header Controls Demo
    // ═══════════════════════════════════════════════════════════════

    // Schema Templates
    const SCHEMA_TEMPLATES = {
      user: {
        type: 'object',
        properties: {
          id: { type: 'integer' },
          username: { type: 'string', minLength: 3 },
          email: { type: 'string', format: 'email' },
          role: { type: 'string', enum: ['admin', 'user', 'guest'] },
          active: { type: 'boolean' }
        },
        required: ['id', 'username', 'email']
      },
      product: {
        type: 'object',
        properties: {
          sku: { type: 'string' },
          name: { type: 'string' },
          price: { type: 'number', minimum: 0 },
          currency: { type: 'string', enum: ['USD', 'EUR', 'GBP'] },
          inStock: { type: 'boolean' },
          tags: { type: 'array', items: { type: 'string' } }
        },
        required: ['sku', 'name', 'price']
      },
      order: {
        type: 'object',
        properties: {
          orderId: { type: 'string' },
          customerId: { type: 'integer' },
          items: {
            type: 'array',
            items: {
              type: 'object',
              properties: {
                productId: { type: 'string' },
                quantity: { type: 'integer', minimum: 1 },
                price: { type: 'number' }
              }
            }
          },
          status: { type: 'string', enum: ['pending', 'shipped', 'delivered'] },
          total: { type: 'number' }
        },
        required: ['orderId', 'customerId', 'items']
      },
      config: {
        type: 'object',
        properties: {
          appName: { type: 'string' },
          version: { type: 'string' },
          debug: { type: 'boolean' },
          features: {
            type: 'object',
            properties: {
              analytics: { type: 'boolean' },
              notifications: { type: 'boolean' },
              darkMode: { type: 'boolean' }
            }
          },
          maxRetries: { type: 'integer', minimum: 0, maximum: 10 }
        }
      }
    };

    // Sample Data Presets
    const DATA_PRESETS = {
      valid: EXAMPLE_DATA,
      minimal: {
        id: 1,
        name: 'Test User',
        email: 'test@example.com'
      },
      full: {
        id: 42,
        name: 'Alice Johnson',
        email: 'alice@company.com',
        age: 28,
        isActive: true,
        role: 'admin',
        address: {
          street: '456 Oak Avenue',
          city: 'San Francisco',
          zipCode: '94102',
          country: 'USA'
        },
        tags: ['team-lead', 'developer', 'reviewer', 'mentor'],
        settings: {
          theme: 'auto',
          notifications: true,
          language: 'en-US'
        }
      },
      invalid: {
        id: 'not-a-number',
        name: 123,
        email: 'invalid-email',
        age: -5,
        role: 'superuser'
      }
    };

    // Lightweight toast
    const toast = document.querySelector('.toast');
    let toastTimeout;
    function showToast(message) {
      clearTimeout(toastTimeout);
      toast.textContent = message;
      toast.classList.add('show');
      toastTimeout = setTimeout(() => toast.classList.remove('show'), 1500);
    }

    // Helper to download JSON
    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Schema template selector
    document.getElementById('select-schema-template').addEventListener('change', (e) => {
      const template = SCHEMA_TEMPLATES[e.target.value];
      if (template) {
        editor.schema = template;
        e.target.value = ''; // Reset selector
      }
    });

    // Data preset selector
    document.getElementById('select-data-preset').addEventListener('change', (e) => {
      const preset = DATA_PRESETS[e.target.value];
      if (preset) {
        editor.data = preset;
        e.target.value = ''; // Reset selector
      }
    });

    // Copy schema button
    document.getElementById('btn-copy-schema').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(JSON.stringify(editor.schema, null, 2));
        showToast('Schema copied');
      } catch (e) {
        console.error('Failed to copy schema:', e);
      }
    });

    // Copy data button
    document.getElementById('btn-copy-data').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(JSON.stringify(editor.data, null, 2));
        showToast('Data copied');
      } catch (e) {
        console.error('Failed to copy data:', e);
      }
    });

    // Download schema button
    document.getElementById('btn-download-schema').addEventListener('click', () => {
      downloadJSON(editor.schema, 'schema.json');
      showToast('Schema exported');
    });

    // Download data button
    document.getElementById('btn-download-data').addEventListener('click', () => {
      downloadJSON(editor.data, 'data.json');
      showToast('Data exported');
    });

    // ═══════════════════════════════════════════════════════════════
    // Public API Examples (for console testing)
    // ═══════════════════════════════════════════════════════════════

    // Expose editor to window for console testing
    window.editor = editor;

    console.log('%c JEDI Editor API ', 'background: #1d4ed8; color: white; padding: 4px 8px; border-radius: 4px;');
    console.log('Available commands:');
    console.log('  editor.schema        - Get current schema');
    console.log('  editor.data          - Get current data');
    console.log('  editor.isValid       - Check if data is valid');
    console.log('  editor.errors        - Get validation errors');
    console.log('  editor.getState()    - Get { schema, data, isValid, errors }');
    console.log('  editor.setState(schema, data) - Set both at once');
    console.log('  editor.validate()    - Re-validate and get result');
    console.log('  editor.debugGrid     - Toggle debug grid overlay');
    console.log('  editor.theme         - Get/set theme ("dark" or "light")');
    console.log('  editor.getAvailableThemes() - Get list of themes');
  </script>
</body>
</html>
